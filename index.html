<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ†ãƒ‹ã‚¹ãƒãƒƒãƒãƒ»ãƒ—ãƒ­ v3.0 (Fair)</title>
    <style>
        :root {
            --main-green: #2c8a4b;
            --court-blue: #4e8bc4;
            --clay-orange: #e07030;
            --bg-gray: #f4f6f8;
            --error-red: #ff6b6b;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: #333;
        }
        header {
            background-color: var(--main-green);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 50px;
        }

        /* ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        .card-header {
            font-weight: bold;
            margin-bottom: 12px;
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .radio-group {
            display: flex;
            gap: 10px;
        }
        .radio-btn {
            flex: 1;
        }
        .radio-btn input {
            display: none;
        }
        .radio-btn label {
            display: block;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .radio-btn input:checked + label {
            background: #e8f5e9;
            border-color: var(--main-green);
            color: var(--main-green);
            font-weight: bold;
        }

        /* æ•°å­—å…¥åŠ› */
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--main-green);
        }

        /* é¸æ‰‹åå…¥åŠ› */
        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-generate {
            width: 100%;
            padding: 15px;
            background-color: var(--main-green);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #1e5c32;
            transition: active 0.1s;
            margin-top: 10px;
        }
        .btn-generate:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* ãƒãƒƒãƒã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .match-card {
            border-left: 5px solid var(--court-blue);
            position: relative;
        }
        .match-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--court-blue);
            font-weight: bold;
        }
        .match-body {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }
        .team-box {
            flex: 1;
            text-align: center;
            background: #f8f9fa;
            padding: 10px 5px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
        }
        .score-input {
            width: 40px;
            text-align: center;
            font-size: 18px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 0 5px;
        }
        .btn-finish {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        /* å¾…æ©Ÿ & ã‚¨ãƒ©ãƒ¼ */
        .waiting-card {
            background: #fff9db;
            border-left: 5px solid #fcc419;
            color: #664d03;
        }
        .error-msg {
            color: var(--error-red);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        /* å±¥æ­´ */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .history-item:last-child { border-bottom: none; }
        .winner { color: var(--main-green); font-weight: bold; }
        .loser { color: #999; }
        .score-badge { background: #333; color: white; padding: 2px 6px; border-radius: 4px; margin: 0 5px; }

        .btn-reset {
            font-size: 12px;
            color: #dc3545;
            background: white;
            border: 1px solid #dc3545;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼æ³¨æ„äº‹é … */
        .footer-note {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 30px;
            line-height: 1.5;
        }
        
        /* çµ±è¨ˆæƒ…å ± (ãƒ‡ãƒãƒƒã‚°ç”¨ã ãŒä¾¿åˆ©ãªã®ã§è¡¨ç¤º) */
        .stats-info {
            font-size: 11px;
            color: #666;
            background: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <header>ğŸ¾ ãƒ†ãƒ‹ã‚¹ãƒãƒƒãƒãƒ»ãƒ—ãƒ­</header>

    <div class="container">
        
        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="card">
            <div class="card-header">âš™ï¸ ã‚²ãƒ¼ãƒ è¨­å®š</div>

            <!-- 1. ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ« (ã‚·ãƒ³ã‚°ãƒ«ã‚¹/ãƒ€ãƒ–ãƒ«ã‚¹) -->
            <div class="form-group">
                <span class="form-label">1. ã‚²ãƒ¼ãƒ å½¢å¼</span>
                <div class="radio-group">
                    <div class="radio-btn">
                        <input type="radio" name="gameMode" id="modeDouble" value="double" checked onchange="updateValidation()">
                        <label for="modeDouble">ãƒ€ãƒ–ãƒ«ã‚¹ (2 vs 2)</label>
                    </div>
                    <div class="radio-btn">
                        <input type="radio" name="gameMode" id="modeSingle" value="single" onchange="updateValidation()">
                        <label for="modeSingle">ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (1 vs 1)</label>
                    </div>
                </div>
            </div>

            <!-- 2. å‚åŠ è€…æ•° -->
            <div class="form-group">
                <span class="form-label">2. å‚åŠ è€…æ•° (3ã€œ12å)</span>
                <input type="number" id="playerCountInput" min="3" max="12" placeholder="æ•°å­—ã‚’å…¥åŠ› (ä¾‹: 6)" oninput="updatePlayerPlaceholder()">
                <div id="countError" class="error-msg">âš ï¸ äººæ•°ã¯3åã‹ã‚‰12åã®é–“ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>
            </div>

            <!-- 3. ã‚³ãƒ¼ãƒˆæ•° -->
            <div class="form-group">
                <span class="form-label">3. ä½¿ç”¨ã‚³ãƒ¼ãƒˆæ•°</span>
                <div class="radio-group">
                    <div class="radio-btn">
                        <input type="radio" name="courtCount" id="court1" value="1" checked>
                        <label for="court1">1é¢</label>
                    </div>
                    <div class="radio-btn">
                        <input type="radio" name="courtCount" id="court2" value="2">
                        <label for="court2">2é¢</label>
                    </div>
                </div>
            </div>

            <!-- åå‰å…¥åŠ› (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ãŒå¿…é ˆæ¤œè¨¼) -->
            <div class="form-group">
                <span class="form-label">å‚åŠ è€…åå…¥åŠ›</span>
                <textarea id="playerNames" placeholder="åå‰ã‚’ã‚«ãƒ³ãƒ(,)ã¾ãŸã¯èª­ç‚¹(ã€)ã§åŒºåˆ‡ã£ã¦ãã ã•ã„ã€‚"></textarea>
                <div style="text-align:right; font-size:12px; color:#888; margin-top:4px;">
                    å…¥åŠ›æ¸ˆã¿: <span id="currentNameCount">0</span>å / ç›®æ¨™: <span id="targetNameCount">0</span>å
                </div>
                <div id="nameMismatchError" class="error-msg">âš ï¸ è¨­å®šã—ãŸäººæ•°ã¨å…¥åŠ›ã•ã‚ŒãŸåå‰ã®æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚</div>
            </div>

            <button onclick="generateMatches()" class="btn-generate">ğŸ² å¯¾æˆ¦è¡¨ã‚’ä½œæˆ (å…¬å¹³æ€§é‡è¦–)</button>
            <div style="text-align:center; font-size:11px; color:#666; margin-top:5px;">
                â€»ä¼‘æ†©ã—ãŸäººã¯æ¬¡å›å„ªå…ˆçš„ã«é¸ã°ã‚Œã¾ã™ã€‚
            </div>
        </div>

        <!-- é€²è¡Œä¸­ã®ãƒãƒƒãƒ -->
        <div class="card-header" style="padding:0 10px; margin-bottom:10px; border:none;">ğŸ”¥ é€²è¡Œä¸­ã®è©¦åˆ</div>
        <div id="active-matches">
            <div style="text-align:center; color:#999; padding:20px; background:white; border-radius:12px;">
                ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>

        <!-- å±¥æ­´ -->
        <div class="card" style="margin-top:20px;">
            <div class="card-header">
                <span>ğŸ“‹ è©¦åˆè¨˜éŒ² (æœ€æ–°20ä»¶)</span>
                <button onclick="resetHistory()" class="btn-reset">è¨˜éŒ²ãƒ»çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div id="history-list" class="history-list">
                <!-- è¨˜éŒ²ã‚¢ã‚¤ãƒ†ãƒ  -->
            </div>
        </div>

        <!-- æ³¨æ„äº‹é … (Footer) -->
        <div class="footer-note">
            å½“ãƒšãƒ¼ã‚¸ã¯äºˆå‘Šãªãä¿®æ­£ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>ã‚ã‚‰ã‹ã˜ã‚ã”äº†æ‰¿ãã ã•ã„ã€‚
        </div>

    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹å¤‰æ•°
        let currentMatches = [];
        let matchHistory = [];
        // å…¬å¹³æ€§ã®ãŸã‚ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ { "åå‰": { played: 0, lastWasRest: false } }
        let playerStats = {}; 

        // åˆæœŸåŒ–ãŠã‚ˆã³ãƒ­ãƒ¼ãƒ‰
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updatePlayerPlaceholder();
            renderMatches();
            renderHistory();

            document.getElementById('playerNames').addEventListener('input', () => {
                updateNameCount();
                saveData(); 
            });
        });

        // UIæ›´æ–°é–¢æ•°ç¾¤
        function updatePlayerPlaceholder() {
            const countInput = document.getElementById('playerCountInput');
            let count = parseInt(countInput.value);
            document.getElementById('countError').style.display = 'none';
            if (isNaN(count)) count = 0;
            document.getElementById('targetNameCount').textContent = count;
            updateNameCount();
        }

        function updateNameCount() {
            const text = document.getElementById('playerNames').value;
            const names = text.split(/,|\n|ã€/).map(s => s.trim()).filter(s => s !== "");
            document.getElementById('currentNameCount').textContent = names.length;
            document.getElementById('nameMismatchError').style.display = 'none';
        }

        function updateValidation() { }

        // â˜… å…¬å¹³ãªé¸æŠœãƒ­ã‚¸ãƒƒã‚¯ (Weight-based Selection)
        function getFairSelection(allNames, neededCount) {
            // 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæœŸåŒ–
            allNames.forEach(name => {
                if (!playerStats[name]) {
                    playerStats[name] = { played: 0, lastWasRest: false };
                }
            });

            // 2. ã‚¹ã‚³ã‚¢è¨ˆç®—
            let candidates = allNames.map(name => {
                let stat = playerStats[name];
                let score = 0;

                // ãƒ«ãƒ¼ãƒ«A: å‰å›ä¼‘æ†©ã—ãŸäººã¯è¶…å„ªå…ˆ (+1000ç‚¹)
                if (stat.lastWasRest) {
                    score += 1000; 
                }

                // ãƒ«ãƒ¼ãƒ«B: è©¦åˆæ•°ãŒå¤šã„ã»ã©å„ªå…ˆåº¦ã‚’ä¸‹ã’ã‚‹ (-50ç‚¹/è©¦åˆ)
                // ã“ã‚Œã«ã‚ˆã‚Šè©¦åˆæ•°ãŒå°‘ãªã„äººãŒè‡ªç„¶ã¨é¸ã°ã‚Œã‚‹
                score -= (stat.played * 50);

                // ãƒ«ãƒ¼ãƒ«C: ãƒ©ãƒ³ãƒ€ãƒ è¦ç´  (0~10ç‚¹)
                // è©¦åˆæ•°ãŒåŒã˜äººåŒå£«ã®é †ä½ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã™ã‚‹
                score += Math.random() * 10;

                return { name: name, score: score };
            });

            // 3. ã‚¹ã‚³ã‚¢ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
            candidates.sort((a, b) => b.score - a.score);

            // 4. é¸æŠœã¨å¾…æ©Ÿã«åˆ†ã‘ã‚‹
            const selectedObj = candidates.slice(0, neededCount);
            const waitingObj = candidates.slice(neededCount);
            
            const selectedNames = selectedObj.map(c => c.name);
            const waitingNames = waitingObj.map(c => c.name);

            return { selectedNames, waitingNames };
        }

        // é¸æŠœã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã®ãƒšã‚¢æ±ºã‚ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- æ ¸å¿ƒ: å¯¾æˆ¦è¡¨ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function generateMatches() {
            // è¨­å®šå–å¾—
            const mode = document.querySelector('input[name="gameMode"]:checked').value;
            const targetCount = parseInt(document.getElementById('playerCountInput').value);
            const courtLimit = parseInt(document.querySelector('input[name="courtCount"]:checked').value);
            const nameText = document.getElementById('playerNames').value;
            
            let allPlayers = nameText.split(/,|\n|ã€/).map(s => s.trim()).filter(s => s !== "");

            // æ¤œè¨¼
            const countError = document.getElementById('countError');
            const nameError = document.getElementById('nameMismatchError');
            countError.style.display = 'none';
            nameError.style.display = 'none';

            if (isNaN(targetCount) || targetCount < 3 || targetCount > 12) {
                countError.style.display = 'block';
                alert("å‚åŠ è€…æ•°ã¯3åä»¥ä¸Š12åä»¥ä¸‹ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (mode === 'double' && targetCount < 4) {
                alert("ãƒ€ãƒ–ãƒ«ã‚¹ã¯æœ€ä½4åãŒå¿…è¦ã§ã™ã€‚");
                return;
            }
            if (allPlayers.length !== targetCount) {
                nameError.style.display = 'block';
                alert(`è¨­å®šäººæ•°(${targetCount}å)ã¨å…¥åŠ›æ•°(${allPlayers.length}å)ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚`);
                return;
            }

            // --- å…¬å¹³é¸æŠœãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ ---
            
            // å¿…è¦ãªç·äººæ•°ã‚’è¨ˆç®—
            let playersPerCourt = (mode === 'double') ? 4 : 2;
            let totalNeeded = playersPerCourt * courtLimit;
            
            // ã‚‚ã—å‚åŠ è€…ãŒè¶³ã‚Šãªã„å ´åˆã¯ã€å¯èƒ½ãªé™ã‚ŠåŸ‹ã‚ã‚‹
            if (totalNeeded > allPlayers.length) {
                // ã‚³ãƒ¼ãƒˆã‚’æ¸›ã‚‰ã™ãªã©ã®èª¿æ•´ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯å˜ã«å…¨å“¡é¸ã¶
                totalNeeded = allPlayers.length; 
                // (ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã¯ç«¯æ•°ãŒå‡ºã‚‹ãŒã€å¾Œç¶šå‡¦ç†ã§ã‚³ãƒ¼ãƒˆãŒä½œã‚‰ã‚Œãªããªã‚‹)
            }

            // å…¬å¹³ã«é¸æŠœ
            const selection = getFairSelection(allPlayers, totalNeeded);
            let selectedPool = selection.selectedNames;
            let waitingPool = selection.waitingNames;

            // é¸ã°ã‚ŒãŸäººãŸã¡ã ã‘ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ« (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ±ºã‚)
            selectedPool = shuffleArray(selectedPool);

            currentMatches = []; 
            let matchIndex = 0;

            // ã‚³ãƒ¼ãƒˆå‰²ã‚Šå½“ã¦
            for (let c = 1; c <= courtLimit; c++) {
                if (selectedPool.length >= playersPerCourt) {
                    const teamA = [];
                    const teamB = [];
                    
                    if (mode === 'double') {
                        teamA.push(selectedPool.shift(), selectedPool.shift());
                        teamB.push(selectedPool.shift(), selectedPool.shift());
                    } else {
                        teamA.push(selectedPool.shift());
                        teamB.push(selectedPool.shift());
                    }

                    currentMatches.push({
                        id: Date.now() + Math.random(),
                        court: c,
                        mode: mode,
                        teamA: teamA,
                        teamB: teamB,
                        scoreA: '',
                        scoreB: ''
                    });
                    matchIndex++;
                }
            }

            // å¾…æ©Ÿè€…ãƒªã‚¹ãƒˆä½œæˆ
            // ä½™ã£ãŸäºº(selectedPoolã®æ®‹ã‚Š)ã‚‚å¾…æ©Ÿã«å›ã™
            waitingPool = waitingPool.concat(selectedPool);
            
            if (waitingPool.length > 0) {
                currentMatches.push({
                    isWaiting: true,
                    players: waitingPool
                });
            }

            // â˜… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° (é¸ã°ã‚ŒãŸäººã¯played+1, ä¼‘ã‚“ã äººã¯lastWasRest=true)
            updateStats(currentMatches, waitingPool);

            saveData();
            renderMatches();
        }

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
        function updateStats(matches, waitingPool) {
            // ã¾ãšå…¨å“¡ã® lastWasRest ã‚’ false ã«ãƒªã‚»ãƒƒãƒˆã—ãŸã„ãŒã€
            // ä»Šå›ä¼‘ã‚“ã äººã ã‘ true ã«ã™ã‚‹æ–¹ãŒç®¡ç†ã—ã‚„ã™ã„
            
            // è©¦åˆã«å‡ºãŸäººã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            matches.forEach(m => {
                if (!m.isWaiting) {
                    const players = m.teamA.concat(m.teamB);
                    players.forEach(name => {
                        if (playerStats[name]) {
                            playerStats[name].played += 1;
                            playerStats[name].lastWasRest = false; // è©¦åˆã—ãŸã®ã§ä¼‘æ†©ãƒ•ãƒ©ã‚°è§£é™¤
                        }
                    });
                }
            });

            // ä¼‘æ†©ã—ãŸäººã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            waitingPool.forEach(name => {
                if (playerStats[name]) {
                    playerStats[name].lastWasRest = true; // æ¬¡å›å„ªå…ˆãƒ•ãƒ©ã‚°
                }
            });
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°: é€²è¡Œä¸­ã®ãƒãƒƒãƒ
        function renderMatches() {
            const container = document.getElementById('active-matches');
            container.innerHTML = "";

            if (currentMatches.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:20px; background:white; border-radius:12px;">è¨­å®šå¾Œã€å¯¾æˆ¦è¡¨ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            currentMatches.forEach((match, index) => {
                if (match.isWaiting) {
                    container.innerHTML += `
                        <div class="card waiting-card" style="padding:15px;">
                            <div style="font-weight:bold; margin-bottom:5px;">â˜• å¾…æ©Ÿ / ä¼‘æ†© (${match.players.length}å)</div>
                            <div>${match.players.join(', ')}</div>
                        </div>
                    `;
                } else {
                    const teamAText = match.teamA.join('<br>');
                    const teamBText = match.teamB.join('<br>');
                    const modeLabel = match.mode === 'double' ? 'ãƒ€ãƒ–ãƒ«ã‚¹' : 'ã‚·ãƒ³ã‚°ãƒ«ã‚¹';

                    container.innerHTML += `
                        <div class="card match-card" style="padding:15px;">
                            <div class="match-header">
                                <span>ã‚³ãƒ¼ãƒˆ ${match.court} (${modeLabel})</span>
                                <span>é€²è¡Œä¸­</span>
                            </div>
                            <div class="match-body">
                                <div class="team-box">
                                    ${teamAText}
                                </div>
                                <input type="tel" class="score-input" value="${match.scoreA}" placeholder="0" onchange="updateScore(${index}, 'A', this.value)">
                                <span style="color:#999; font-weight:bold;">:</span>
                                <input type="tel" class="score-input" value="${match.scoreB}" placeholder="0" onchange="updateScore(${index}, 'B', this.value)">
                                <div class="team-box">
                                    ${teamBText}
                                </div>
                            </div>
                            <button class="btn-finish" onclick="finishMatch(${index})">è©¦åˆçµ‚äº†ãƒ»è¨˜éŒ²ä¿å­˜</button>
                        </div>
                    `;
                }
            });
        }

        function updateScore(index, team, value) {
            if (team === 'A') currentMatches[index].scoreA = value;
            else currentMatches[index].scoreB = value;
            saveData();
        }

        function finishMatch(index) {
            const match = currentMatches[index];
            if (!match.scoreA || !match.scoreB) {
                if(!confirm("ã‚¹ã‚³ã‚¢å…¥åŠ›ãªã—ã§çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) return;
            }

            const historyItem = {
                time: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}),
                ...match
            };
            
            matchHistory.unshift(historyItem);
            if (matchHistory.length > 20) {
                matchHistory = matchHistory.slice(0, 20); 
            }

            currentMatches.splice(index, 1);
            
            saveData();
            renderMatches();
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = "";

            if (matchHistory.length === 0) {
                container.innerHTML = '<div style="padding:15px; text-align:center; color:#ccc;">è¨˜éŒ²ã•ã‚ŒãŸè©¦åˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                return;
            }

            matchHistory.forEach(match => {
                const sA = parseInt(match.scoreA) || 0;
                const sB = parseInt(match.scoreB) || 0;
                const teamAClass = sA > sB ? 'winner' : (sA < sB ? 'loser' : '');
                const teamBClass = sB > sA ? 'winner' : (sB < sA ? 'loser' : '');
                
                const teamAStr = match.teamA.join(', ');
                const teamBStr = match.teamB.join(', ');

                container.innerHTML += `
                    <div class="history-item">
                        <div style="flex:1; text-align:right;" class="${teamAClass}">${teamAStr}</div>
                        <span class="score-badge">${match.scoreA} : ${match.scoreB}</span>
                        <div style="flex:1; text-align:left;" class="${teamBClass}">${teamBStr}</div>
                    </div>
                `;
            });
        }

        function resetHistory() {
            if(confirm("ã™ã¹ã¦ã®è©¦åˆè¨˜éŒ²ã¨å…¬å¹³æ€§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n(æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™)")) {
                matchHistory = [];
                playerStats = {}; // çµ±è¨ˆã‚‚ãƒªã‚»ãƒƒãƒˆ
                saveData();
                renderHistory();
            }
        }

        function saveData() {
            localStorage.setItem('tp_jp_mode', document.querySelector('input[name="gameMode"]:checked').value);
            localStorage.setItem('tp_jp_count', document.getElementById('playerCountInput').value);
            localStorage.setItem('tp_jp_court', document.querySelector('input[name="courtCount"]:checked').value);
            localStorage.setItem('tp_jp_names', document.getElementById('playerNames').value);
            localStorage.setItem('tp_jp_matches', JSON.stringify(currentMatches));
            localStorage.setItem('tp_jp_history', JSON.stringify(matchHistory));
            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
            localStorage.setItem('tp_jp_stats', JSON.stringify(playerStats));
        }

        function loadData() {
            const mode = localStorage.getItem('tp_jp_mode');
            if(mode) document.querySelector(`input[name="gameMode"][value="${mode}"]`).checked = true;

            const count = localStorage.getItem('tp_jp_count');
            if(count) document.getElementById('playerCountInput').value = count;

            const court = localStorage.getItem('tp_jp_court');
            if(court) document.querySelector(`input[name="courtCount"][value="${court}"]`).checked = true;

            const names = localStorage.getItem('tp_jp_names');
            if(names) document.getElementById('playerNames').value = names;

            const matches = localStorage.getItem('tp_jp_matches');
            if(matches) currentMatches = JSON.parse(matches);

            const history = localStorage.getItem('tp_jp_history');
            if(history) matchHistory = JSON.parse(history);

            // çµ±è¨ˆãƒ­ãƒ¼ãƒ‰
            const stats = localStorage.getItem('tp_jp_stats');
            if(stats) playerStats = JSON.parse(stats);
        }
    </script>
</body>
</html>
